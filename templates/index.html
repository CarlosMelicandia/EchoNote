{% extends "base.html" %}

{% block title %}EchoNote{% endblock %}

{% block content %}
<div class="two-column-layout">
    <div class="recording-panel">
        <h2>Start Recording</h2>
        <div class="mic-button" id="btn-record">
            <div class="mic-icon"></div>
        </div>
        <button class="btn-stop" id="btn-stop" disabled>Stop Recording</button>
        <textarea placeholder="What would you like to accomplish today" 
        id="transcript" 
        name="transcript" 
        rows="4" 
        style="overflow: hidden; 
        word-wrap: break-word; 
        resize: none; 
        height: 320px;"></textarea>  
        <button class="btn-save" id="btn-save">Save</button>
    </div>
    <div class="tasks-panel">
        <h2>Tasks</h2>
        <div class="task-list">
            {% if tasks %}
                {% for task in tasks %}
                <div class="task-item {% if task.completed %}completed{% endif %}" data-task-id="{{ task.id }}">
                    <div class="task-content">
                        {{ task.name }}
                        {% if task.due_date %} â€” <strong>Due:</strong> {{ task.due_date }}{% endif %}
                        {% if task.completed %} (Done){% endif %}
                    </div>
                    <div class="task-actions">
                        {% if not task.completed %}
                        <button class="btn-done" data-task-id="{{ task.id }}">
                            <i class="fa-solid fa-check"></i>
                            </button>
                            
                            {% else %}
                            <button class="btn-undo" data-task-id="{{ task.id }}">
                            <i class="fa-solid fa-rotate-left"></i>
                            </button>
                            {% endif %}
                            
                            <button class="btn-edit" data-task-id="{{ task.id }}">
                            <i class="fa-solid fa-pen"></i>
                            </button>
                            
                            <button class="btn-delete" data-task-id="{{ task.id }}">
                            <i class="fa-solid fa-trash"></i>
                            </button>
                            <button class="btn-sync" data-task-id="{{ task.id }}">
                            <i class="fa-solid fa-calendar"></i>
                            </button>
                            <button class="btn-sync-task" data-task-id="{{ task.id }}">
                            <i class="fa-solid fa-list-check"></i>
                            </button>
                          
                    </div>
                    <div class="task-waveform"></div>
                </div>
                {% endfor %}
            {% else %}
                <p>No tasks yet. Start recording to create tasks.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function convertTo24Hour(timeStr) {
        if (!timeStr) return "";

        const [time, modifier] = timeStr.split(" ");
        let [hours, minutes] = time.split(":").map(Number);

        if (modifier === "PM" && hours < 12) hours += 12;
        if (modifier === "AM" && hours === 12) hours = 0;

        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
    }
    //converts date strings like "today", "tomorrow", or weekdays to a date input format
    //wouldnt work if its says 7pm today. now this function strips the time and returns the date
    function convertToDateInput(dateStr) {
        if (!dateStr) return '';

        const today = new Date();
        let target = new Date();

        if (dateStr.toLowerCase() === 'today') {
            target = new Date();
        } else if (dateStr.toLowerCase() === 'tomorrow') {
            target.setDate(today.getDate() + 1);
        } else {
            const weekdays = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            if (weekdays.includes(dateStr)) {
                const targetDay = weekdays.indexOf(dateStr);
                const diff = (targetDay - today.getDay() + 7) % 7 || 7;
                target.setDate(today.getDate() + diff);
            } else {
                const parsed = new Date(dateStr + " " + today.getFullYear());
                if (!isNaN(parsed)) target = parsed;
            }
        }

        return target.toISOString().split('T')[0]; // returns 'YYYY-MM-DD'
    }

    document.addEventListener('DOMContentLoaded', function() {
        const recordButton = document.getElementById('btn-record');
        const stopButton = document.getElementById('btn-stop');
        const saveButton = document.getElementById('btn-save');
        const transcriptArea = document.getElementById('transcript');
        
        let recorder;
        let stream;
        
        // Initialize media recording
        navigator.mediaDevices.getUserMedia({ audio: true }).then(
            mediaStream => {
                stream = mediaStream;
                recorder = new MediaRecorder(stream);
                let chunks = [];

                recorder.ondataavailable = e => chunks.push(e.data);
                recorder.onstop = async () => {
                    const blob = new Blob(chunks, { type: 'audio/webm'});
                    chunks = [];

                    const form = new FormData();
                    form.append('audio', blob, 'recording.webm')

                    try {
                        const res = await fetch('/api/transcribe', { method: 'POST', body: form});
                        const payload = await res.json();
                        if (!res.ok) throw new Error(payload.error || "Transcription failed");
                        transcriptArea.value = payload.transcript;
                    } catch (error) {
                        console.error('Error transcribing audio:', error);
                        transcriptArea.value = 'Error transcribing audio. Please try again.';
                    }
                };
            }
        ).catch(error => {
            console.error('Error accessing microphone:', error);
            alert('Could not access microphone. Please check permissions.');
        });
        
        //The popup for g-events
        document.querySelectorAll('.btn-sync').forEach(button => {
            button.addEventListener('click', function () {
                const taskItem = this.closest('.task-item');
                const taskContent = taskItem.querySelector('.task-content').innerText;

                //send to genai to extract structured info
                fetch('/api/parse_task', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: taskContent })
                })
                .then(res => res.json())
                .then(data => {
                    //fill the popup using parsed task
                    document.getElementById('popup-title').value = data.text || taskContent;
                    document.getElementById('popup-description').value = '';
                    document.getElementById('popup-start-time').value = '';  // optionally use convertToDateTimeLocal(data.start_time)
                    document.getElementById('popup-end-time').value = '';
                    document.getElementById('popup-recurrence').value = data.repeat || '';
                    document.getElementById('confirmation-popup').style.display = 'block';
                })
                .catch(err => {
                    console.error(err);
                    alert("Failed to parse task for calendar.");
                });
            });
        });

        //popup for the g-tasks
        document.querySelectorAll('.btn-sync-task').forEach(button => {
            button.addEventListener('click', function () {
                const taskItem = this.closest('.task-item');
                const taskContent = taskItem.querySelector('.task-content').innerText;
                
                //send to genai to extract structured info
                fetch('/api/parse_task', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: taskContent })
                })
                .then(res => res.json())
                .then(data => {
                    //fill the popup using parsed task
                    document.getElementById('task-title').value = data.text || taskContent;
                    document.getElementById('task-due-date').value = convertToDateInput(data.due);
                    document.getElementById('task-popup').style.display = 'block';
                })
                .catch(err => {
                    console.error(err);
                    alert("Failed to parse task for Google Task.");
                });
            });
        });

        // Record button
        recordButton.addEventListener('click', function() {
            if (recorder && recorder.state === 'inactive') {
                recorder.start();
                recordButton.classList.add('recording');
                stopButton.disabled = false;
            }
        });

        // Stop button
        stopButton.addEventListener('click', function() {
            if (recorder && recorder.state === 'recording') {
                recorder.stop();
                recordButton.classList.remove('recording');
                stopButton.disabled = true;
                
                // Stop all tracks
                if (stream) {
                    stream.getTracks().forEach(track => {
                        if (track.readyState === 'live') {
                            track.stop();
                        }
                    });
                }
                
                // Reinitialize for next recording
                navigator.mediaDevices.getUserMedia({ audio: true }).then(
                    mediaStream => {
                        stream = mediaStream;
                        recorder = new MediaRecorder(stream);
                        let chunks = [];

                        recorder.ondataavailable = e => chunks.push(e.data);
                        recorder.onstop = async () => {
                            const blob = new Blob(chunks, { type: 'audio/webm'});
                            chunks = [];

                            const form = new FormData();
                            form.append('audio', blob, 'recording.webm')

                            try {
                                const res = await fetch('/api/transcribe', { method: 'POST', body: form});
                                const payload = await res.json();
                                if (!res.ok) throw new Error(payload.error || "Transcription failed");
                                transcriptArea.value = payload.transcript;
                            } catch (error) {
                                console.error('Error transcribing audio:', error);
                                transcriptArea.value = 'Error transcribing audio. Please try again.';
                            }
                        };
                    }
                ).catch(console.error);
            }
        });

        // Save button
        saveButton.addEventListener('click', async function() {
            const transcript = transcriptArea.value.trim();
            
            if (!transcript) {
                alert('Please record something first.');
                return;
            }
            
            try {
                const response = await fetch('/api/save_task', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        transcript: transcript
                    })
                });
                
                if (response.ok) {
                    // Clear the transcript area
                    transcriptArea.value = '';
                    
                    // Refresh the page to show the new task
                    window.location.reload();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to save task');
                }
            } catch (error) {
                console.error('Error saving task:', error);
                alert('Error saving task: ' + error.message);
            }
        });
    });   

</script>
<div id="confirmation-popup" style="display: none;" class="popup-overlay">
  <div class="popup-box">
    <h3>Confirm Event</h3>
    <form id="confirm-form">
      <label for="popup-title">Title:</label>
      <input type="text" id="popup-title" name="title" required />
    
      <label for="popup-description">Description:</label>
      <textarea id="popup-description" name="description"></textarea>

      <label for="popup-start-time">Start Time:</label>
      <input type="datetime-local" id="popup-start-time" name="start_time" required />

      <label for="popup-end-time">End Time:</label>
      <input type="datetime-local" id="popup-end-time" name="end_time" required />

      <label for="popup-recurrence">Recurrence:</label>
      <select id="popup-recurrence" name="recurrence">
        <option value="">None</option>
        <option value="daily">Daily</option>
        <option value="weekdays">Weekdays</option>
        <option value="weekly">Weekly</option>
        <option value="monthly">Monthly</option>
      </select>

      <div class="form-buttons">
        <button type="submit">Confirm & Add</button>
        <button type="button" id="cancel-btn">Cancel</button>
      </div>
    </form>
  </div>
</div>

<div id="task-popup" style="display: none;" class="popup-overlay">
  <div class="popup-box">
    <h3>Confirm Task</h3>
    <form id="task-form">
      <label for="task-title">Title:</label>
      <input type="text" id="task-title" name="title" required />

      <label for="task-due-date">Due Date:</label>
      <input type="date" id="task-due-date" name="due_date" />

      <div class="form-buttons">
        <button type="submit">Confirm & Add</button>
        <button type="button" id="cancel-task-btn">Cancel</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}
