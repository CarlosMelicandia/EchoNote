{% extends "base.html" %}

{% block title %}EchoNote - Appearance{% endblock %}

{% block content %}
  {% if current_user.is_authenticated %}
    <div class="appearance-container">
      <h2>Customize Appearance</h2>
      <div class="appearance-grid">
        <div class="appearance-card">
          <h3>Theme Colors</h3>
          <div class="color-option">
            <label for="bg-primary">Background Primary:</label>
            <input type="color" id="bg-primary" class="color-picker">
          </div>
          <div class="color-option">
            <label for="bg-secondary">Background Secondary:</label>
            <input type="color" id="bg-secondary" class="color-picker">
          </div>
          <div class="color-option">
            <label for="text-primary">Text Primary:</label>
            <input type="color" id="text-primary" class="color-picker">
          </div>
          <div class="color-option">
            <label for="text-secondary">Text Secondary:</label>
            <input type="color" id="text-secondary" class="color-picker">
          </div>
          <div class="color-option">
            <label for="accent">Accent Color:</label>
            <input type="color" id="accent" class="color-picker">
          </div>
          <div class="color-option">
            <label for="button-text">Button Text:</label>
            <input type="color" id="button-text" class="color-picker">
          </div>
          <div class="color-option">
            <label for="border-color">Border Color:</label>
            <input type="color" id="border-color" class="color-picker">
          </div>
        </div>
        <div class="appearance-card">
          <h3>Preset Themes</h3>
          <div class="preset-themes">
            <button class="preset-btn" data-theme="default">Default Dark</button>
            <button class="preset-btn" data-theme="light">Light Mode</button>
            <button class="preset-btn" data-theme="midnight">Midnight Blue</button>
            <button class="preset-btn" data-theme="forest">Forest Green</button>
            <button class="preset-btn" data-theme="sunset">Sunset Orange</button>
            <button class="preset-btn" data-theme="high-contrast">High Contrast</button>
          </div>
          <h3 class="preview-title">Preview</h3>
          <div class="theme-preview">
            <div class="preview-nav">Navigation</div>
            <div class="preview-content">
              <div class="preview-task">Sample Task 1</div>
              <div class="preview-task">Sample Task 2</div>
              <button class="preview-button">Button</button>
            </div>
          </div>
        </div>
      </div>
      <div class="action-buttons">
        <button id="save-theme">Save Theme</button>
        <button id="reset-theme">Reset to Default</button>
      </div>
    </div>
  {% else %}
    <p>You must <a href="{{ url_for('login') }}">log in</a> to customize your theme.</p>
  {% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', async () => {
  // default fallback
  const defaultTheme = {
    bgPrimary: '#212121',
    bgSecondary: '#303030',
    textPrimary: '#ececf1',
    textSecondary: '#ffffff',
    accent:      '#FCFCFD',
    buttonText:  '#36395A',
    borderColor: '#444'
  };

  // grab all the pickers into a map
  const pickers = {
    bgPrimary:   document.getElementById('bg-primary'),
    bgSecondary: document.getElementById('bg-secondary'),
    textPrimary: document.getElementById('text-primary'),
    textSecondary: document.getElementById('text-secondary'),
    accent:      document.getElementById('accent'),
    buttonText:  document.getElementById('button-text'),
    borderColor: document.getElementById('border-color'),
  };

  // helper to convert camelCase to CSS var name
  function camelToVar(name) {
    return '--' + name.replace(/([A-Z])/g, m => '-' + m.toLowerCase());
  }

  // fetch the current theme from server
  let theme;
  try {
    const resp = await fetch('/api/get_theme');
    theme = (resp.ok ? await resp.json() : defaultTheme);
  } catch {
    theme = defaultTheme;
  }

  // apply theme to pickers & document
  for (const [key, picker] of Object.entries(pickers)) {
    picker.value = theme[key] || defaultTheme[key];
    document.documentElement.style.setProperty(camelToVar(key), picker.value);
    // live‐update on change
    picker.addEventListener('input', () => {
      document.documentElement.style.setProperty(camelToVar(key), picker.value);
    });
  }

  // preset buttons
  const presets = {
    default: defaultTheme,
    light: {
      bgPrimary:'#f5f5f5', bgSecondary:'#BDBDBD',
      textPrimary:'#FFFFFF', textSecondary:'#000000',
      accent:'#3a86ff', buttonText:'#ffffff', borderColor:'#cccccc'
    },
    midnight: {
      bgPrimary:'#0f172a', bgSecondary:'#1e293b',
      textPrimary:'#e2e8f0', textSecondary:'#f8fafc',
      accent:'#38bdf8', buttonText:'#0f172a', borderColor:'#334155'
    },
    forest: {
      bgPrimary:'#1e3a29', bgSecondary:'#2d503c',
      textPrimary:'#e0f2e9', textSecondary:'#ffffff',
      accent:'#7fcd91', buttonText:'#1e3a29', borderColor:'#3a6a4b'
    },
    sunset: {
      bgPrimary:'#2b2118', bgSecondary:'#3d2c1e',
      textPrimary:'#f9e0c9', textSecondary:'#ffffff',
      accent:'#ff9e5c', buttonText:'#2b2118', borderColor:'#5c4535'
    },
    'high-contrast': {
      bgPrimary:'#000000', bgSecondary:'#1a1a1a',
      textPrimary:'#ffffff', textSecondary:'#ffffff',
      accent:'#ffff00', buttonText:'#000000', borderColor:'#ffffff'
    }
  };
  document.querySelectorAll('.preset-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const p = presets[btn.dataset.theme] || defaultTheme;
      for (const [k,v] of Object.entries(p)) {
        pickers[k].value = v;
        document.documentElement.style.setProperty(camelToVar(k), v);
      }
    });
  });

  // reset button
  document.getElementById('reset-theme').addEventListener('click', () => {
    for (const [k,v] of Object.entries(defaultTheme)) {
      pickers[k].value = v;
      document.documentElement.style.setProperty(camelToVar(k), v);
    }
  });

  // save button — POST back to /api/save_theme
  document.getElementById('save-theme').addEventListener('click', async () => {
    const payload = {};
    for (const key of Object.keys(pickers)) {
      payload[key] = pickers[key].value;
    }
    try {
      const res = await fetch('/api/save_theme', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error(res.status);
      alert('Theme saved for {{ current_user.username }}');
    } catch(err) {
      console.error('save_theme failed', err);
      alert('Could not save theme: ' + err);
    }
  });
});
</script>
{% endblock %}